name: Build iOS App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest

    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ” Show Xcode Version
      run: |
        xcodebuild -version
        swift --version

    - name: ðŸ“‹ List Project Files
      run: |
        ls -la
        echo "---"
        find . -name "*.xcodeproj" -o -name "*.xcworkspace"

    - name: ðŸ”¨ Build Project
      run: |
        xcodebuild build \
          -project FamilyCalendar.xcodeproj \
          -scheme FamilyCalendar \
          -configuration Debug \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_BITCODE=NO \
          | xcpretty || cat build.log

    - name: ðŸ“¦ Find Built App
      run: |
        echo "Searching for built .app file..."
        find ~/Library/Developer/Xcode/DerivedData -name "FamilyCalendar.app" -type d 2>/dev/null | head -5

    - name: ðŸ“¦ Create Build Directory
      run: |
        mkdir -p build/IPA
        mkdir -p build/Payload

    - name: ðŸ“‹ Copy App to Build Directory
      run: |
        # æŸ¥æ‰¾æž„å»ºçš„ .app æ–‡ä»¶
        APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "FamilyCalendar.app" -type d 2>/dev/null | grep -i "Debug-iphoneos" | head -1)

        if [ -z "$APP_PATH" ]; then
          echo "âš ï¸ App not found in DerivedData, trying alternative location..."
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -name "FamilyCalendar.app" -type d 2>/dev/null | head -1)
        fi

        if [ -z "$APP_PATH" ]; then
          echo "âŒ Could not find built app!"
          exit 1
        fi

        echo "âœ… Found app at: $APP_PATH"
        ls -lh "$APP_PATH"

        # å¤åˆ¶ app
        cp -r "$APP_PATH" build/Payload/

    - name: ðŸ“¦ Create IPA
      run: |
        cd build
        zip -r FamilyCalendar.ipa Payload/
        ls -lh FamilyCalendar.ipa

    - name: âœ… Verify IPA
      run: |
        if [ -f build/FamilyCalendar.ipa ]; then
          echo "âœ… IPA created successfully!"
          ls -lh build/FamilyCalendar.ipa
          unzip -l build/FamilyCalendar.ipa | head -20
        else
          echo "âŒ IPA not found!"
          exit 1
        fi

    - name: ðŸ“¦ Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: FamilyCalendar-${{ github.run_number }}
        path: build/FamilyCalendar.ipa
        retention-days: 30

    - name: ðŸ“ Create Summary
      run: |
        echo "## âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- **FamilyCalendar-${{ github.run_number }}.ipa**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“² How to Install" >> $GITHUB_STEP_SUMMARY
        echo "1. Download the IPA file" >> $GITHUB_STEP_SUMMARY
        echo "2. Install [AltStore](https://altstore.io/)" >> $GITHUB_STEP_SUMMARY
        echo "3. Use AltStore to install the IPA" >> $GITHUB_STEP_SUMMARY
